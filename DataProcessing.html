<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta http-equiv="x-ua-compatible" content="IE=9" >

<title>Data Processing for SNF Project</title>

<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 12px;
   margin: 8px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 { 
   font-size:2.2em; 
}

h2 { 
   font-size:1.8em; 
}

h3 { 
   font-size:1.4em; 
}

h4 { 
   font-size:1.0em; 
}

h5 { 
   font-size:0.9em; 
}

h6 { 
   font-size:0.8em; 
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre {	
   margin-top: 0;
   max-width: 95%;
   border: 1px solid #ccc;
   white-space: pre-wrap;
}

pre code {
   display: block; padding: 0.5em;
}

code.r, code.cpp {
   background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * { 
      background: transparent !important; 
      color: black !important; 
      filter:none !important; 
      -ms-filter: none !important; 
   }

   body { 
      font-size:12pt; 
      max-width:100%; 
   }
       
   a, a:visited { 
      text-decoration: underline; 
   }

   hr { 
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote { 
      padding-right: 1em; 
      page-break-inside: avoid; 
   }

   tr, img { 
      page-break-inside: avoid; 
   }

   img { 
      max-width: 100% !important; 
   }

   @page :left { 
      margin: 15mm 20mm 15mm 10mm; 
   }
     
   @page :right { 
      margin: 15mm 10mm 15mm 20mm; 
   }

   p, h2, h3 { 
      orphans: 3; widows: 3; 
   }

   h2, h3 { 
      page-break-after: avoid; 
   }
}

</style>

<!-- Styles for R syntax highlighter -->
<style type="text/css">
   pre .operator,
   pre .paren {
     color: rgb(104, 118, 135)
   }

   pre .literal {
     color: rgb(88, 72, 246)
   }

   pre .number {
     color: rgb(0, 0, 205);
   }

   pre .comment {
     color: rgb(76, 136, 107);
   }

   pre .keyword {
     color: rgb(0, 0, 255);
   }

   pre .identifier {
     color: rgb(0, 0, 0);
   }

   pre .string {
     color: rgb(3, 106, 7);
   }
</style>

<!-- R syntax highlighter -->
<script type="text/javascript">
var hljs=new function(){function m(p){return p.replace(/&/gm,"&amp;").replace(/</gm,"&lt;")}function f(r,q,p){return RegExp(q,"m"+(r.cI?"i":"")+(p?"g":""))}function b(r){for(var p=0;p<r.childNodes.length;p++){var q=r.childNodes[p];if(q.nodeName=="CODE"){return q}if(!(q.nodeType==3&&q.nodeValue.match(/\s+/))){break}}}function h(t,s){var p="";for(var r=0;r<t.childNodes.length;r++){if(t.childNodes[r].nodeType==3){var q=t.childNodes[r].nodeValue;if(s){q=q.replace(/\n/g,"")}p+=q}else{if(t.childNodes[r].nodeName=="BR"){p+="\n"}else{p+=h(t.childNodes[r])}}}if(/MSIE [678]/.test(navigator.userAgent)){p=p.replace(/\r/g,"\n")}return p}function a(s){var r=s.className.split(/\s+/);r=r.concat(s.parentNode.className.split(/\s+/));for(var q=0;q<r.length;q++){var p=r[q].replace(/^language-/,"");if(e[p]){return p}}}function c(q){var p=[];(function(s,t){for(var r=0;r<s.childNodes.length;r++){if(s.childNodes[r].nodeType==3){t+=s.childNodes[r].nodeValue.length}else{if(s.childNodes[r].nodeName=="BR"){t+=1}else{if(s.childNodes[r].nodeType==1){p.push({event:"start",offset:t,node:s.childNodes[r]});t=arguments.callee(s.childNodes[r],t);p.push({event:"stop",offset:t,node:s.childNodes[r]})}}}}return t})(q,0);return p}function k(y,w,x){var q=0;var z="";var s=[];function u(){if(y.length&&w.length){if(y[0].offset!=w[0].offset){return(y[0].offset<w[0].offset)?y:w}else{return w[0].event=="start"?y:w}}else{return y.length?y:w}}function t(D){var A="<"+D.nodeName.toLowerCase();for(var B=0;B<D.attributes.length;B++){var C=D.attributes[B];A+=" "+C.nodeName.toLowerCase();if(C.value!==undefined&&C.value!==false&&C.value!==null){A+='="'+m(C.value)+'"'}}return A+">"}while(y.length||w.length){var v=u().splice(0,1)[0];z+=m(x.substr(q,v.offset-q));q=v.offset;if(v.event=="start"){z+=t(v.node);s.push(v.node)}else{if(v.event=="stop"){var p,r=s.length;do{r--;p=s[r];z+=("</"+p.nodeName.toLowerCase()+">")}while(p!=v.node);s.splice(r,1);while(r<s.length){z+=t(s[r]);r++}}}}return z+m(x.substr(q))}function j(){function q(x,y,v){if(x.compiled){return}var u;var s=[];if(x.k){x.lR=f(y,x.l||hljs.IR,true);for(var w in x.k){if(!x.k.hasOwnProperty(w)){continue}if(x.k[w] instanceof Object){u=x.k[w]}else{u=x.k;w="keyword"}for(var r in u){if(!u.hasOwnProperty(r)){continue}x.k[r]=[w,u[r]];s.push(r)}}}if(!v){if(x.bWK){x.b="\\b("+s.join("|")+")\\s"}x.bR=f(y,x.b?x.b:"\\B|\\b");if(!x.e&&!x.eW){x.e="\\B|\\b"}if(x.e){x.eR=f(y,x.e)}}if(x.i){x.iR=f(y,x.i)}if(x.r===undefined){x.r=1}if(!x.c){x.c=[]}x.compiled=true;for(var t=0;t<x.c.length;t++){if(x.c[t]=="self"){x.c[t]=x}q(x.c[t],y,false)}if(x.starts){q(x.starts,y,false)}}for(var p in e){if(!e.hasOwnProperty(p)){continue}q(e[p].dM,e[p],true)}}function d(B,C){if(!j.called){j();j.called=true}function q(r,M){for(var L=0;L<M.c.length;L++){if((M.c[L].bR.exec(r)||[null])[0]==r){return M.c[L]}}}function v(L,r){if(D[L].e&&D[L].eR.test(r)){return 1}if(D[L].eW){var M=v(L-1,r);return M?M+1:0}return 0}function w(r,L){return L.i&&L.iR.test(r)}function K(N,O){var M=[];for(var L=0;L<N.c.length;L++){M.push(N.c[L].b)}var r=D.length-1;do{if(D[r].e){M.push(D[r].e)}r--}while(D[r+1].eW);if(N.i){M.push(N.i)}return f(O,M.join("|"),true)}function p(M,L){var N=D[D.length-1];if(!N.t){N.t=K(N,E)}N.t.lastIndex=L;var r=N.t.exec(M);return r?[M.substr(L,r.index-L),r[0],false]:[M.substr(L),"",true]}function z(N,r){var L=E.cI?r[0].toLowerCase():r[0];var M=N.k[L];if(M&&M instanceof Array){return M}return false}function F(L,P){L=m(L);if(!P.k){return L}var r="";var O=0;P.lR.lastIndex=0;var M=P.lR.exec(L);while(M){r+=L.substr(O,M.index-O);var N=z(P,M);if(N){x+=N[1];r+='<span class="'+N[0]+'">'+M[0]+"</span>"}else{r+=M[0]}O=P.lR.lastIndex;M=P.lR.exec(L)}return r+L.substr(O,L.length-O)}function J(L,M){if(M.sL&&e[M.sL]){var r=d(M.sL,L);x+=r.keyword_count;return r.value}else{return F(L,M)}}function I(M,r){var L=M.cN?'<span class="'+M.cN+'">':"";if(M.rB){y+=L;M.buffer=""}else{if(M.eB){y+=m(r)+L;M.buffer=""}else{y+=L;M.buffer=r}}D.push(M);A+=M.r}function G(N,M,Q){var R=D[D.length-1];if(Q){y+=J(R.buffer+N,R);return false}var P=q(M,R);if(P){y+=J(R.buffer+N,R);I(P,M);return P.rB}var L=v(D.length-1,M);if(L){var O=R.cN?"</span>":"";if(R.rE){y+=J(R.buffer+N,R)+O}else{if(R.eE){y+=J(R.buffer+N,R)+O+m(M)}else{y+=J(R.buffer+N+M,R)+O}}while(L>1){O=D[D.length-2].cN?"</span>":"";y+=O;L--;D.length--}var r=D[D.length-1];D.length--;D[D.length-1].buffer="";if(r.starts){I(r.starts,"")}return R.rE}if(w(M,R)){throw"Illegal"}}var E=e[B];var D=[E.dM];var A=0;var x=0;var y="";try{var s,u=0;E.dM.buffer="";do{s=p(C,u);var t=G(s[0],s[1],s[2]);u+=s[0].length;if(!t){u+=s[1].length}}while(!s[2]);if(D.length>1){throw"Illegal"}return{r:A,keyword_count:x,value:y}}catch(H){if(H=="Illegal"){return{r:0,keyword_count:0,value:m(C)}}else{throw H}}}function g(t){var p={keyword_count:0,r:0,value:m(t)};var r=p;for(var q in e){if(!e.hasOwnProperty(q)){continue}var s=d(q,t);s.language=q;if(s.keyword_count+s.r>r.keyword_count+r.r){r=s}if(s.keyword_count+s.r>p.keyword_count+p.r){r=p;p=s}}if(r.language){p.second_best=r}return p}function i(r,q,p){if(q){r=r.replace(/^((<[^>]+>|\t)+)/gm,function(t,w,v,u){return w.replace(/\t/g,q)})}if(p){r=r.replace(/\n/g,"<br>")}return r}function n(t,w,r){var x=h(t,r);var v=a(t);var y,s;if(v){y=d(v,x)}else{return}var q=c(t);if(q.length){s=document.createElement("pre");s.innerHTML=y.value;y.value=k(q,c(s),x)}y.value=i(y.value,w,r);var u=t.className;if(!u.match("(\\s|^)(language-)?"+v+"(\\s|$)")){u=u?(u+" "+v):v}if(/MSIE [678]/.test(navigator.userAgent)&&t.tagName=="CODE"&&t.parentNode.tagName=="PRE"){s=t.parentNode;var p=document.createElement("div");p.innerHTML="<pre><code>"+y.value+"</code></pre>";t=p.firstChild.firstChild;p.firstChild.cN=s.cN;s.parentNode.replaceChild(p.firstChild,s)}else{t.innerHTML=y.value}t.className=u;t.result={language:v,kw:y.keyword_count,re:y.r};if(y.second_best){t.second_best={language:y.second_best.language,kw:y.second_best.keyword_count,re:y.second_best.r}}}function o(){if(o.called){return}o.called=true;var r=document.getElementsByTagName("pre");for(var p=0;p<r.length;p++){var q=b(r[p]);if(q){n(q,hljs.tabReplace)}}}function l(){if(window.addEventListener){window.addEventListener("DOMContentLoaded",o,false);window.addEventListener("load",o,false)}else{if(window.attachEvent){window.attachEvent("onload",o)}else{window.onload=o}}}var e={};this.LANGUAGES=e;this.highlight=d;this.highlightAuto=g;this.fixMarkup=i;this.highlightBlock=n;this.initHighlighting=o;this.initHighlightingOnLoad=l;this.IR="[a-zA-Z][a-zA-Z0-9_]*";this.UIR="[a-zA-Z_][a-zA-Z0-9_]*";this.NR="\\b\\d+(\\.\\d+)?";this.CNR="\\b(0[xX][a-fA-F0-9]+|(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)";this.BNR="\\b(0b[01]+)";this.RSR="!|!=|!==|%|%=|&|&&|&=|\\*|\\*=|\\+|\\+=|,|\\.|-|-=|/|/=|:|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|\\?|\\[|\\{|\\(|\\^|\\^=|\\||\\|=|\\|\\||~";this.ER="(?![\\s\\S])";this.BE={b:"\\\\.",r:0};this.ASM={cN:"string",b:"'",e:"'",i:"\\n",c:[this.BE],r:0};this.QSM={cN:"string",b:'"',e:'"',i:"\\n",c:[this.BE],r:0};this.CLCM={cN:"comment",b:"//",e:"$"};this.CBLCLM={cN:"comment",b:"/\\*",e:"\\*/"};this.HCM={cN:"comment",b:"#",e:"$"};this.NM={cN:"number",b:this.NR,r:0};this.CNM={cN:"number",b:this.CNR,r:0};this.BNM={cN:"number",b:this.BNR,r:0};this.inherit=function(r,s){var p={};for(var q in r){p[q]=r[q]}if(s){for(var q in s){p[q]=s[q]}}return p}}();hljs.LANGUAGES.cpp=function(){var a={keyword:{"false":1,"int":1,"float":1,"while":1,"private":1,"char":1,"catch":1,"export":1,virtual:1,operator:2,sizeof:2,dynamic_cast:2,typedef:2,const_cast:2,"const":1,struct:1,"for":1,static_cast:2,union:1,namespace:1,unsigned:1,"long":1,"throw":1,"volatile":2,"static":1,"protected":1,bool:1,template:1,mutable:1,"if":1,"public":1,friend:2,"do":1,"return":1,"goto":1,auto:1,"void":2,"enum":1,"else":1,"break":1,"new":1,extern:1,using:1,"true":1,"class":1,asm:1,"case":1,typeid:1,"short":1,reinterpret_cast:2,"default":1,"double":1,register:1,explicit:1,signed:1,typename:1,"try":1,"this":1,"switch":1,"continue":1,wchar_t:1,inline:1,"delete":1,alignof:1,char16_t:1,char32_t:1,constexpr:1,decltype:1,noexcept:1,nullptr:1,static_assert:1,thread_local:1,restrict:1,_Bool:1,complex:1},built_in:{std:1,string:1,cin:1,cout:1,cerr:1,clog:1,stringstream:1,istringstream:1,ostringstream:1,auto_ptr:1,deque:1,list:1,queue:1,stack:1,vector:1,map:1,set:1,bitset:1,multiset:1,multimap:1,unordered_set:1,unordered_map:1,unordered_multiset:1,unordered_multimap:1,array:1,shared_ptr:1}};return{dM:{k:a,i:"</",c:[hljs.CLCM,hljs.CBLCLM,hljs.QSM,{cN:"string",b:"'\\\\?.",e:"'",i:"."},{cN:"number",b:"\\b(\\d+(\\.\\d*)?|\\.\\d+)(u|U|l|L|ul|UL|f|F)"},hljs.CNM,{cN:"preprocessor",b:"#",e:"$"},{cN:"stl_container",b:"\\b(deque|list|queue|stack|vector|map|set|bitset|multiset|multimap|unordered_map|unordered_set|unordered_multiset|unordered_multimap|array)\\s*<",e:">",k:a,r:10,c:["self"]}]}}}();hljs.LANGUAGES.r={dM:{c:[hljs.HCM,{cN:"number",b:"\\b0[xX][0-9a-fA-F]+[Li]?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+(?:[eE][+\\-]?\\d*)?L\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+\\.(?!\\d)(?:i\\b)?",e:hljs.IMMEDIATE_RE,r:1},{cN:"number",b:"\\b\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\.\\d+(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"keyword",b:"(?:tryCatch|library|setGeneric|setGroupGeneric)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\.",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\d+(?![\\w.])",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\b(?:function)",e:hljs.IMMEDIATE_RE,r:2},{cN:"keyword",b:"(?:if|in|break|next|repeat|else|for|return|switch|while|try|stop|warning|require|attach|detach|source|setMethod|setClass)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"literal",b:"(?:NA|NA_integer_|NA_real_|NA_character_|NA_complex_)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"literal",b:"(?:NULL|TRUE|FALSE|T|F|Inf|NaN)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"identifier",b:"[a-zA-Z.][a-zA-Z0-9._]*\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"<\\-(?!\\s*\\d)",e:hljs.IMMEDIATE_RE,r:2},{cN:"operator",b:"\\->|<\\-",e:hljs.IMMEDIATE_RE,r:1},{cN:"operator",b:"%%|~",e:hljs.IMMEDIATE_RE},{cN:"operator",b:">=|<=|==|!=|\\|\\||&&|=|\\+|\\-|\\*|/|\\^|>|<|!|&|\\||\\$|:",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"%",e:"%",i:"\\n",r:1},{cN:"identifier",b:"`",e:"`",r:0},{cN:"string",b:'"',e:'"',c:[hljs.BE],r:0},{cN:"string",b:"'",e:"'",c:[hljs.BE],r:0},{cN:"paren",b:"[[({\\])}]",e:hljs.IMMEDIATE_RE,r:0}]}};
hljs.initHighlightingOnLoad();
</script>




</head>

<body>
<h1>Data Processing for SNF Project</h1>

<h2>Loading Data in R</h2>

<pre><code class="r">setwd(&#39;~/Dropbox/VizD3/snf_researcher&#39;) # Set working directory
library(&#39;data.table&#39;) # Efficient data.table operations
</code></pre>

<p>The file <em>Dataset2.csv</em> is exported from the xlsx file as the original csv file is corrupted.</p>

<pre><code class="r">dat &lt;- fread(&#39;data/Dataset2.csv&#39;)
head(dat)
</code></pre>

<pre><code>##    Project_ID Project_year Host_Country
## 1:     121200         2008           GB
## 2:     121205         2008           BE
## 3:     121376         2008           DE
## 4:     121376         2008           DE
## 5:     121376         2008           CA
## 6:     121437         2008           US
##                                                                                     HostInstitute
## 1:                                                       Department of Computing Imperial College
## 2:                                                                 Katholieke Universiteit Leuven
## 3:                              Deutsches Institut für Internationale Pädagogische Forschung DIPF
## 4: Fakultät für Erziehungswissenschaft, Psychologie und Bewegungswissenschaft Universität Hamburg
## 5:                                       Institute for Studies in Education University of Toronto
## 6:                                             Department of Psychology University of Connecticut
##    ZIPcode_Host      Host_city project_start Project_end
## 1:      SW7 2BZ         London    01.05.2008  30.04.2009
## 2:         3000         Leuven    01.09.2008  31.05.2009
## 3:        60486 Frankfurt a.M.    01.01.2009  31.12.2010
## 4:        20146        Hamburg    01.01.2009  31.12.2010
## 5:      M5S IV6        Toronto    01.01.2009  31.12.2010
## 6:   06269-1020         Storrs    01.09.2008  31.08.2009
##             MainDisciplin MainDiscNummer
## 1: Philosophy, psychology            101
## 2: Philosophy, psychology            101
## 3: Philosophy, psychology            101
## 4: Philosophy, psychology            101
## 5: Philosophy, psychology            101
## 6: Philosophy, psychology            101
</code></pre>

<pre><code class="r">summary(dat)
</code></pre>

<pre><code>##    Project_ID      Project_year  Host_Country       HostInstitute     
##  Min.   :120877   Min.   :2008   Length:5065        Length:5065       
##  1st Qu.:130988   1st Qu.:2009   Class :character   Class :character  
##  Median :139875   Median :2011   Mode  :character   Mode  :character  
##  Mean   :139520   Mean   :2011                                        
##  3rd Qu.:148433   3rd Qu.:2013                                        
##  Max.   :157677   Max.   :2014                                        
##  ZIPcode_Host        Host_city         project_start     
##  Length:5065        Length:5065        Length:5065       
##  Class :character   Class :character   Class :character  
##  Mode  :character   Mode  :character   Mode  :character  
##                                                          
##                                                          
##                                                          
##  Project_end        MainDisciplin      MainDiscNummer
##  Length:5065        Length:5065        Min.   :101   
##  Class :character   Class :character   1st Qu.:102   
##  Mode  :character   Mode  :character   Median :203   
##                                        Mean   :187   
##                                        3rd Qu.:301   
##                                        Max.   :309
</code></pre>

<h2>Column renaming</h2>

<p>For column name, the python/c++ standard will be used.</p>

<pre><code class="r">setnames(dat, old=names(dat), new=tolower(names(dat)))
setnames(dat, c(&#39;hostinstitute&#39;, &#39;maindisciplin&#39;, &#39;maindiscnummer&#39;),
          c(&#39;host_institute&#39;, &#39;main_disciplin&#39;, &#39;main_disc_nummer&#39;))
</code></pre>

<h2>Date processing</h2>

<pre><code class="r">ProcessDate &lt;- function(x){
  return(as.POSIXct(strptime(x, format = &#39;%d.%m.%Y&#39;, tz = &#39;UTC&#39;)))
}

cols &lt;- c(&#39;project_start&#39;, &#39;project_end&#39;)
for (col in cols) dat[, (col) := ProcessDate(get(col))]
dat[, project_length := project_end - project_start] # Project length
</code></pre>

<h2>Reduce variance in bias-variance trade-off</h2>

<p>There are too many disciplines. Hence any analysis would be bound to have too much variances and it might be better to perform the analysis on the base disciplin first and then if time allows to run the analysis with the more refined data.</p>

<pre><code class="r">dat[, base_disciplin := main_disc_nummer %/% 100]
dt.bdisc &lt;- data.table(base_disciplin = c(1,2,3),
 base_disc_name = c(&#39;Social Sciences&#39;, &#39;Basic Sciences&#39;, &#39;Biology_Med&#39;))
setkey(dat, base_disciplin)
dat &lt;- dat[J(dt.bdisc)]

dat[, host_city := tolower(host_city)] # case not sensitive
</code></pre>

<h2>Add Countries in full name</h2>

<p>A full name of the country is appened in order to draw the maps.</p>

<p>The <em>country.csv</em> file can found at this <a href="https://github.com/umpirsky/country-list/edit/master/country/cldr/en/country.csv">github link</a>.</p>

<pre><code class="r">country &lt;- fread(&#39;data/country.csv&#39;)

setkey(country, iso2) # Use data.table Join
setkey(dat, host_country)
dat &lt;- country[J(dat)]
</code></pre>

<h2>NA treatment</h2>

<p>There are some NA (mainly because of the new country has not been entered yet).</p>

<pre><code class="r">nrow(dat) - sum(complete.cases(dat)) # Number of incomplete case
dat &lt;- na.omit(dat)
setnames(dat, &#39;name&#39;, &#39;country&#39;)
</code></pre>

<h2>Aggregate for maps</h2>

<p>These aggregations will be used to perform spatial analysis. Further, we also count the number of project in a country for a given moment in time (e.g. the number of projects in the USA in February 2001).</p>

<pre><code class="r">dat.lyb &lt;- dat[, .N, by = &#39;iso3,project_year,base_disciplin&#39;] # l for land, y year, b base_discplin
dat.lb &lt;- dat[, .N, by = &#39;iso3,base_disciplin&#39;] # l for land

dat.cyb &lt;- dat[, .N, by = &#39;host_city,project_year,base_disciplin&#39;]
dat.cb &lt;- dat[, .N, by = &#39;host_city,base_disciplin&#39;]

dat.agg &lt;- list(dat.lyb, dat.lb, dat.cyb, dat.cb) # List

### Creates a finer grid for plotting time series.
dat.ts &lt;- data.table(expand.grid(base_disciplin = c(1,2,3),
                      year = seq(2008, 2014), month = seq(1, 12),
                     numcode= unique(dat$numcode)))
dat.ts[, N:= 0];
</code></pre>

<pre><code>##        base_disciplin year month numcode N
##     1:              1 2008     1       8 0
##     2:              2 2008     1       8 0
##     3:              3 2008     1       8 0
##     4:              1 2009     1       8 0
##     5:              2 2009     1       8 0
##    ---                                    
## 19148:              2 2013    12     716 0
## 19149:              3 2013    12     716 0
## 19150:              1 2014    12     716 0
## 19151:              2 2014    12     716 0
## 19152:              3 2014    12     716 0
</code></pre>

<pre><code class="r">setkeyv(dat.ts, names(dat.ts)[-5])

UpdateCountPeriod &lt;- function(x){
  month.delta &lt;- 24*3600*30
  begin.dte &lt;- x$project_start
  end.dte &lt;- x$project_end
  base.disc &lt;- x$base_disciplin
  cty &lt;- x$numcode
  while(begin.dte &lt; end.dte){
    dat.ts[J(base.disc, year(begin.dte), month(begin.dte), cty), N:= N+1]
    begin.dte &lt;- begin.dte + month.delta
  }
}

for (i in seq_along(dat$iso3)){
  UpdateCountPeriod(dat[i])
}

### Update the date
dat.ts[, date:= as.POSIXct(paste0(year, &#39;-&#39;, month, &#39;-1&#39;), tz = &#39;UTC&#39;)];
</code></pre>

<pre><code>##        base_disciplin year month numcode   N       date
##     1:              1 2008     1       8   0 2008-01-01
##     2:              1 2008     1      32   0 2008-01-01
##     3:              1 2008     1      36   0 2008-01-01
##     4:              1 2008     1      40   0 2008-01-01
##     5:              1 2008     1      56   0 2008-01-01
##    ---                                                 
## 19148:              3 2014    12     826  55 2014-12-01
## 19149:              3 2014    12     834   0 2014-12-01
## 19150:              3 2014    12     840 179 2014-12-01
## 19151:              3 2014    12     854   0 2014-12-01
## 19152:              3 2014    12     858   0 2014-12-01
</code></pre>

<h2>Conclusion</h2>

<p>Saving the files.</p>

<pre><code class="r">head(dat)
</code></pre>

<pre><code>##    iso2   country  iso_name iso3 numcode base_disciplin project_id
## 1:   AL   Albania   ALBANIA  ALB       8              1     148453
## 2:   AR Argentina ARGENTINA  ARG      32              1     123687
## 3:   AR Argentina ARGENTINA  ARG      32              1     134137
## 4:   AR Argentina ARGENTINA  ARG      32              1     142962
## 5:   AR Argentina ARGENTINA  ARG      32              1     142790
## 6:   AR Argentina ARGENTINA  ARG      32              1     126162
##    project_year
## 1:         2013
## 2:         2008
## 3:         2010
## 4:         2012
## 5:         2012
## 6:         2009
##                                                                                          host_institute
## 1:                                                       Archäologisches Museum Korça Universität Korça
## 2:                                  Facultad de Derecho y Ciencias Sociales Universidad de Buenos Aires
## 3:                                                      Facultad de Derecho Universidad de Buenos Aires
## 4: Center for Distributive, Labor &amp; Social Stud Facultad de Ciencias Económicas Universidad de La Plata
## 5:                                 Universidad de Buenos Aires Facultad de Ciencias Economicas CEINLADI
## 6:                           Instituto Diversidad Cultural y Procesos Universidad Nacional de Río Negro
##    zipcode_host               host_city project_start project_end
## 1:                                korça    2013-09-01  2014-11-30
## 2:     C1425CKB  ciudad de buenos aires    2008-09-01  2009-11-30
## 3:         1425            buenos aires    2011-04-01  2012-03-31
## 4:         1900                la plata    2012-08-01  2013-01-31
## 5:     C1120AAQ            buenos aires    2012-09-01  2013-08-31
## 6:     R8403BNH san carlos de bariloche    2009-08-01  2013-04-30
##     main_disciplin main_disc_nummer project_length  base_disc_name
## 1:     Art studies              104       455 days Social Sciences
## 2: Social sciences              102       455 days Social Sciences
## 3: Social sciences              102       365 days Social Sciences
## 4: Social sciences              102       183 days Social Sciences
## 5:         History              103       364 days Social Sciences
## 6:     Art studies              104      1368 days Social Sciences
</code></pre>

<pre><code class="r">save(file=&#39;data/dat_clean.RData&#39;, dat)
save(file=&#39;data/dat_agg_clean.RData&#39;, dat.agg)
write.csv(file=&#39;data/dat_clean.csv&#39;, dat)
write.csv(file=&#39;data/dat_agg_lyb_clean.csv&#39;, dat.lyb)
write.csv(file=&#39;data/dat_ly_ts.csv&#39;, dat.ts)
</code></pre>

</body>

</html>

